#!/bin/sh
set -e # stop if we encounter an error

make clean # clean cruft

svn update # get changes

make -j3 # abuse the cores

# don't copy over stuff with permissions that make it useless
chmod a+r * -R
rsync --exclude .svn --exclude .deps --exclude svn --exclude dist --exclude releases --exclude torbutton-current.xpi --exclude project -Prvz --delete . vescum.torproject.org:/srv/www-master.torproject.org/htdocs

echo "Forcing mirror update"
ssh vescum.torproject.org '/home/mirroradm/bin/trigger-mirrors'
ssh vescum.torproject.org chmod g+w -R /srv/www-master.torproject.org/htdocs
